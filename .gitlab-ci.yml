stages:
  - install
  - deploy

# Define Installing Stage
install_dependencies:
  stage: install
  script:
    - echo "Node.js is already installed"
    - node -v   # Verify Node.js installation
    - npm install   # Install dependencies
    - echo "Building Node.js app"
    - npm run build  # Build the project if applicable
  artifacts:
    paths:
      - build   # Store the build folder as an artifact (if building a frontend)
  cache:
    paths:
      - node_modules/   # Cache node_modules for faster future runs

# Deploy Stage
deploy_to_ec2:
  stage: deploy
  only:
    - develop
  before_script:
    - 'which ssh-agent || (brew install openssh)'
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $AWS_SSH_IP >> ~/.ssh/known_hosts
  script:
    - echo "Deploying application to EC2"
    - scp -i ~/.ssh/agtech.pem -r ./* $AWS_SSH_USER@$AWS_SSH_IP:/home/ubuntu/app/backend/  # Securely copy files to EC2
    - ssh -i ~/.ssh/agtech.pem $AWS_SSH_USER@$AWS_SSH_IP "cd /home/ubuntu/app/backend && npm install"  # SSH to EC2 and install dependencies
    - ssh -i ~/.ssh/agtech.pem $AWS_SSH_USER@$AWS_SSH_IP "pm2 restart all"  # Restart app using PM2
  environment:
    name: development
    url: http://$AWS_SSH_IP
  cache:
    paths:
      - node_modules/
